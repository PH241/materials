---
title: "R for Epidemiology, Lab 4"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(epiR)
library(ORCI)
wcgs <- read.dta("wcgs.dta")
```
\center PH241, Spring 2019 \center

In this lab, we'll cover tools you'll need to complete Homework 5, including:
* Hypothesis testing
* Confidence intervals
* Obtaining critical values and p-values from Gaussian and $\chi^{2}$

## 1 Hypothesis tests, confidence intervals, and $\chi^{2}$
We’ll be using the WCGS dataset, as in lab 2. Load it into R.
In this dataset, each man in the study is represented by a row. Each row contains, among other variables, the values of two binary (0/1 indicator) variables called chd69 (Coronary Heart Disease) and arcus0 (Arcus senilis, a ring in the corneal margin or around the iris that can indicate CHD).

### 1.1 The Normal approximation for proportions, exact confidence intervals, and Fisher’s exact test
Using the Normal curve for inferences about proportions is actually an approximation. For confidence intervals for a proportion, the number of observed successes and failures should be at least 10. For hypothesis tests about a proportion, the expected numbers of successes and failures should be at least 10. For two-sample problems with binary outcomes, where the data are summarized in a 2 x 2 table, the criteria are a bit different – many authors say that the observed counts in each cell should be greater than 5 to use the Normal approximation, and for the two-sample test for proportion or the equivalent $\chi^{2}$ test, the expected counts should all be greater than 5.

What if our data don’t satisfy the assumptions for the Normal or $\chi^{2}$ distributions? For these situations, there are exact tests based on the binomial distribution and its relatives. Using `epi.2by2` from the `epiR` package, R  allows us to request exact p-values and construct "exact" confidence intervals.

#### 1.1.1 Creating a 2 x 2 table
We begin by creating a 2 x 2 table, using the `table` function:
> *Generic:* table(data$dependentvariable, data$independent_variable)

```{r}
chd.arc <- table(wcgs$chd69, wcgs$arcus0)
chd.arc
```
This creates a basic 2 x 2 table for our data. However, in order to pass this to `epi.2by2` to do the calculations, we need to have the disease/exposed count on the upper-lefthand corner and the non-disease/non-exposed count on the lower right-hand corner.  

#### 1.1.2 Modifying the table to fit epi.2by2
Since our data is in the wrong order, we need to reorder our table before we can pass it to `epi.2by2`. To do this, we can use `relevel`. 
*Note: you only need to do this if your data is in the wrong order*

```{r}
chd.arc <- table(relevel(as.factor(wcgs$chd69), '1'), relevel(as.factor(wcgs$arcus0), '1'))
chd.arc
```

#### 1.1.3 Using `epi.2by2`
We can now pass our table to `epi.2by2` to tabulate our data.
> *Generic:* epi.2by2(*2x2table*)

```{r}
epi.2by2(chd.arc)
```

#### 1.1.4 Specifying the confidence interval
The default confidence level for `epi.2by2` is 95%. To override this default, reassign the `conf.level` parameter. The confidence level must be between 0 and 1.
> *Generic:* epi.2by2(*2x2table*, conf.level = 0.99)

```{r}
epi.2by2(chd.arc, conf.level = 0.99)
```

#### 1.1.5 Specifying the test method
`epi.2by2` can also calculate appropriate measures of association and measures of effect in the exposed and total population based on the study design upon which the data was collected. By default, `epi.2by2` uses cohort-count. To override this default, reassign the `method` parameter. Options are cohort.count, cohort.time, case.control, or cross.sectional
> *Generic:* epi.2by2(*2x2table*, method = *"method"*)

```{r}
epi.2by2(chd.arc, method = "case.control")
```

<!-- #### 1.1.6 Other confidence intervals -->
<!-- You can also find other confidence intervals using the `ORCI` [package](https://rdrr.io/cran/ORCI/). All functions from this package that calculate confidence intervals follow the format:  -->
<!-- > type.CI(num.events1, num.trials1, num.events2, num.trials2, conf = 0.95) -->

<!-- 1. Woolf -->
<!-- > Woolf.CI(num.events1, num.trials1, num.events2, num.trials2) -->

<!-- ```{r} -->
<!-- chd.arc -->
<!-- chd.arc.woolf.ci <- Woolf.CI(255, 3125, 941, 3152) -->
<!-- chd.arc.woolf.ci -->
<!-- ``` -->

### 1.2 Obtaining critical values and confidence levels
We learned previously how to find the p-value associated with a particular $\chi^{2}$ test statistic by using `pchisq`:
*Remember this value is the area in the right hand tail of the $\chi^{2}$ distribution with a specified number of degrees of freedom.*
```{r}
# 1 is the number of degrees of freedom and 13.6382 is our 
# test statistic from the WCGS dataset example above 
1 - pchisq(13.6382, df = 1)

# or, more elegantly:
pchisq(13.6382, df = 1, lower.tail = FALSE)
```
This is because all cumulative probability functions in R compute left tail probabilities by default. To find the right tail probability, set `lower.tail = FALSE`. This is recommended over taking $1 - p$.

We can similarly find the p-value associated with a particular test statistic (z-value) based on the Standard Normal distribution. For a 2-sided test, this would look like:
```{r}
2 * (1 - pnorm(1.96))
```

The `pchisq`, and `pnorm` functions have inverses `qchisq` and `qnorm` respectively. These functions take a probability as input and will give you its associated critical value. Be careful about making adjustments for 2-tailed tests if you want a particular confidence level. For example, for a 2-tailed test at the 95% confidence level (where α = 0.05), the critical z-value is found as follows:
```{r}
qnorm(.975)
```
Looking up two tails of the χ2 distribution for a hypothesis test is only appropriate when con- structing a confidence interval. Recall that the χ2 distribution is not symmetric, so it is necessary to to look up both tails separately.
```{r}
qchisq(.025, 1)           # where 1 is the degree of freedom
qchisq(.975, 1)
```

